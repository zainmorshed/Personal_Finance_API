events {
    worker_connections 1024;
}
http {
    # Define allowed IPs - replace with your MacBook's IP
    geo $allowed_ip {
        default 0;
        127.0.0.1 1;           # localhost
        10.0.0.161 1;          # Your MacBook's IP
        192.168.65.1 1;        # Docker Desktop host gateway (macOS)
        172.22.0.1 1;
        
        # Docker common gateway IPs
        172.17.0.1 1;          # Default Docker bridge
        172.18.0.1 1;          # Docker Compose networks
        172.21.0.1 1;          # Additional Docker network
        # Add broader Docker network ranges
        172.16.0.0/12 1;       # Covers all Docker networks (172.16-172.31)
        192.168.0.0/16 1;      # Local network range
        10.0.0.0/8 1;          # Private network range
        
        # Docker Desktop common IPs on macOS
        192.168.65.0/24 1;     # Docker Desktop subnet (allows entire range)
    }
    
    # Upstream to Kong
    upstream kong_backend {
        server kong:8000;
    }
    
    server {
        listen 80;  # This is REQUIRED - don't comment it out
        
        # Block all non-whitelisted IPs
        # if ($allowed_ip = 0) {
        #     return 403 "Access denied from IP: $remote_addr";
        # }
        
        # Log access attempts
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
        
        # Proxy all requests to Kong
        location / {
            proxy_pass http://kong_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}